{% extends "base.html" %}
{% block content %}

        <div class="row">

                        <div class="col-lg-3 col-md-6">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <span class="label label-success pull-right" style="padding-top: 5px;">实时</span>
                                    <h5>上传速度</h5>
                                </div>
                                <div class="ibox-content">

                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-arrow-circle-up fa-4x"></i>
                                        </div>
                                        <div class="col-xs-9 text-right" style="padding-left: 5px;">
                                            <h1 class="no-margins" style=" font-weight: bold;" id="last_speed">{{ today_data.last_speed if today_data.last_speed<1024 else (today_data.last_speed/1024*100)|int/100 }}</h1>
                                            <small style=" font-weight: bold;"><span id="speed_unit">{% if today_data.last_speed<1024 %}K{% else %}M{% endif %}</span>Byte/s</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <span class="label label-info pull-right" style="padding-top: 5px;">今日</span>
                                    <h5>水晶产量</h5>
                                </div>
                                <div class="ibox-content">

                                    <div class="row">
                                        <div class="col-xs-3">
                                            <i class="fa fa-rmb fa-4x"></i>
                                        </div>
                                        <div class="col-xs-9 text-right" style="padding-left: 5px;">
                                            <h1 style="font-size: 44px; font-weight: bold;" class="no-margins" id="pdc">{{ convert_to_yuan(today_data.pdc) }}</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <span class="label label-primary pull-right" style="padding-top: 5px;">本周</span>
                                    <h5>水晶产量</h5>
                                </div>
                                <div class="ibox-content" style="height: 88px;">

                                    <div class="row">
                                        <div class="col-xs-12 text-right" style="padding-left: 5px;">
                                            <h1 style="font-size: 44px; font-weight: bold;" class="no-margins" id="w_pdc">{{ convert_to_yuan(today_data.w_pdc) }}</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <span class="label label-danger pull-right" style="padding-top: 5px;">本月</span>
                                    <h5>水晶产量</h5>
                                </div>
                                <div class="ibox-content" style="height: 88px;">

                                    <div class="row">
                                        <div class="col-xs-12 text-right" style="padding-left: 5px;">
                                            <h1 style="font-size: 44px; font-weight: bold;" class="no-margins" id="m_pdc">{{ convert_to_yuan(today_data.m_pdc) }}</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
        <!-- /.row -->
        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <i class="fa fa-bar-chart-o fa-fw"></i> 最近7日产量
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>

                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <!-- /.panel-heading -->
                    <div class="ibox-content">
                        <div id="seven-day-chart" style="height: 250px;"></div>
                    </div>
                    <!-- /.panel-body -->
                </div>
            </div>
            <!-- /.col-lg-8 -->

            <!-- /.col-lg-4 -->
        </div>
        <!-- /.row -->

        <!-- /.row -->
        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <i class="fa fa-bar-chart-o fa-fw"></i> 最近7日速度
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>

                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <!-- /.panel-heading -->
                    <div class="ibox-content">
                        <div id="speed-comparison"></div>
                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->

            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->

{% endblock %}

{% block js_logic %}
    <script src="../static/js/highcharts.js"></script>
    <script>
        $('#seven-day-chart').highcharts({
            chart: {

            },
            title: {
                text: '',
                x: -20 //center
            },
            legend: {
                enabled:false
            },
            credits: {
                enabled: false
            },
            yAxis: [{ // Secondary yAxis
                title: {
                    text: '平均速度 KBytes/s'
                },min: 0,
                labels: {
                    format: '{value}'
                },
                opposite: true
            },{
                title: {
                    text: '产量'
                },
                plotLines: [{
                    value: 0,
                    width: 1
                }]
            }],
            tooltip: {
                shared: true,
                valueSuffix: ''
            },

            xAxis: {
                categories: {{ today_data.seven_days_chart.category | safe }}
            },
            series: {{ today_data.seven_days_chart.value | safe }}
        });

        {% if speed_comparison_data is defined %}
            $('#speed-comparison').highcharts({
                chart: {
                    type: 'spline'

                },
                title: {
                    text: '',
                    x: -20 //center
                },
                credits: {
                    enabled: false
                },
                yAxis: {
                    title: {
                        text: 'Speed (KByte/s)'
                    },min: 0,
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ' KByte/s'
                },
                plotOptions: {
                    spline: {
                        lineWidth: 1,
                        marker: {
                            lineWidth: 1,
                            enabled: false
                        }
                    }
                },

                xAxis: {
                    categories: {{ speed_comparison_data.category | safe }}
                },
                series: {{ speed_comparison_data.value | safe }}
            });
        {% endif %}

        function convert_to_yuan(crystal_values) {
            if (crystal_values >= 10000) {
                return parseInt(crystal_values / 1000) / 10 + '元';
            }
            return crystal_values;
        }
        function convert_speed(speed) {
            if (speed >= 1024) {
                return parseInt(speed / 1024*100) / 100;
            }
            return speed;
        }
        var last_upd_hour = new Date().getHours();
        var load_chart_count = 0;
        function reload_chart(data){

            $('#seven-day-chart').highcharts({
                chart: {

                },
                title: {
                    text: '',
                    x: -20 //center
                },
                legend: {
                    enabled:false
                },
                credits: {
                    enabled: false
                },
                yAxis: [{ // Secondary yAxis
                    title: {
                        text: '平均速度 KBytes/s',
                        style: {
                            color: Highcharts.getOptions().colors[0]
                        }
                    },min: 0,
                    labels: {
                        format: '{value}',
                        style: {
                            color: Highcharts.getOptions().colors[0]
                        }
                    },
                    opposite: true
                },{
                    title: {
                        text: '产量'
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                }],
                plotOptions: {
                    series: {
                        animation: false
                    }
                },
                tooltip: {
                    shared: true,
                    valueSuffix: ''
                },
                xAxis: {
                    categories: data.today_data.seven_days_chart.category
                },
                series: data.today_data.seven_days_chart.value
            });

            if (data.speed_comparison_data != undefined) {
                $('#speed-comparison').highcharts({
                    chart: {
                        type: 'spline'

                    },
                    title: {
                        text: '',
                        x: -20 //center
                    },
                    credits: {
                        enabled: false
                    },
                    yAxis: {
                        title: {
                            text: 'Speed (KByte/s)'
                        }, min: 0,
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    },
                    tooltip: {
                        shared: true,
                        valueSuffix: ' KByte/s'
                    },
                    plotOptions: {
                        spline: {
                            lineWidth: 1,
                            marker: {
                                lineWidth: 1,
                                enabled: false
                            },
                            animation: false
                        }
                    },

                    xAxis: {
                        categories: data.speed_comparison_data.category
                    },
                    series: data.speed_comparison_data.value
                });
            }
        }

        var flash_element = function(jquery_obj){
            jquery_obj.css('margin','0');
            jquery_obj.addClass('animated');
            jquery_obj.addClass('flash');
            setTimeout(function() {
                jquery_obj.removeAttr('class').attr('class', '');
            }, 2000)
        }
        var reload_data = function(){

            $.getJSON( "/dashboard_data", function( data ) {
                if($('#last_speed').html() != convert_speed(data.today_data.last_speed)){
                    $('#last_speed').html(convert_speed(data.today_data.last_speed));

                    if(data.today_data.last_speed > 1024){
                        $('#speed_unit').html('M')
                    }else{
                        $('#speed_unit').html('K')
                    }
                    flash_element($('#last_speed'));
                }
                if($('#pdc').html() != convert_to_yuan(data.today_data.pdc)) {
                    $('#pdc').html(convert_to_yuan(data.today_data.pdc));
                }
                if($('#w_pdc').html() != convert_to_yuan(data.today_data.w_pdc)) {
                    $('#w_pdc').html(convert_to_yuan(data.today_data.w_pdc));
                    flash_element($('#w_pdc'));
                }
                if($('#m_pdc').html() != convert_to_yuan(data.today_data.m_pdc)) {
                    $('#m_pdc').html(convert_to_yuan(data.today_data.m_pdc));
                    flash_element($('#m_pdc'));
                }
                if (last_upd_hour != new Date().getHours()) {
                    if (load_chart_count < 3) {
                        load_chart_count++;
                        reload_chart(data);
                    }
                    else{
                        load_chart_count = 0;
                        last_upd_hour = new Date().getHours();
                    }
                }
            })
        }

        $(document).ready(function(){
            setInterval(reload_data,5000);
        });

    </script>
{% endblock %}

{% block navibar %}
    <div class="col-lg-10">
        <h2>监控中心</h2>
        <ol class="breadcrumb">
            <li>
                <a href="/">Home</a>
            </li>
            <li class="active">
                <strong>Dashboard</strong>
            </li>
        </ol>
    </div>
{% endblock %}
{% set active_page = "dashboard" %}